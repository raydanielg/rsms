import{r as c,q as p,j as Q,c as a,a as O,u as Y,h as Z,w as X,b as n,p as k,o as i,F as x,y as _,n as R,t as d,e as ee,I as C,i as F}from"./app-B6qV5A7i.js";import{_ as te}from"./AuthenticatedLayout-CIuSAw6o.js";const se={class:"flex items-center justify-between"},oe={class:"text-xl font-semibold leading-tight text-gray-800"},ne={class:"space-y-4"},re={class:"rounded-xl border border-gray-100 bg-white p-4 shadow-sm"},ae={class:"flex flex-wrap gap-2"},ie=["onClick"],le={key:0,class:"text-sm text-gray-500"},de={class:"rounded-xl border border-gray-100 bg-white p-4 shadow-sm"},ue={class:"mb-3 flex items-center justify-between"},ce={class:"flex items-center gap-3"},ye={class:"text-xs text-gray-500"},fe={key:0,class:"text-xs font-medium text-rose-700"},ge=["disabled"],me={key:0,class:"mr-1.5 h-3.5 w-3.5 animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},ve={key:0,class:"text-sm text-gray-500"},pe={key:1},xe={key:0,class:"text-sm text-gray-500"},be={key:1,class:"overflow-x-auto"},he={class:"bg-gray-50"},we=["title"],ke={class:"sticky left-0 bg-white px-3 py-2 text-gray-900 whitespace-nowrap border-t border-r border-gray-200"},_e={class:"sticky left-28 bg-white px-3 py-2 text-gray-700 whitespace-nowrap border-t border-r border-gray-200"},Ce={class:"relative inline-block"},Fe=["value","onInput","onChange","onBlur","onKeydown","onPaste","onFocus","data-student","data-subject","disabled"],Se={key:0,class:"pointer-events-none absolute -right-1 -top-1 inline-flex h-3.5 w-3.5 items-center justify-center rounded-full bg-emerald-500 text-white"},Me={key:1,class:"pointer-events-none absolute -right-1 -top-1 inline-flex h-3.5 w-3.5 items-center justify-center rounded-full bg-blue-500/90 text-white"},Ne={class:"px-2 py-1 text-center text-gray-900 font-medium border-t border-l border-gray-200"},Te={class:"px-2 py-1 text-center text-gray-700 border-t border-gray-200"},$e={class:"px-2 py-1 text-center text-gray-700 border-t border-gray-200"},Ae={class:"px-2 py-1 text-center text-gray-700 border-t border-gray-200"},Ke={class:"px-2 py-1 text-center text-gray-700 border-t border-gray-200"},Be={__name:"Marks",props:{exam:{type:Object,required:!0}},setup(g){const b=g,S=c(null),M=c(!1),y=c([]),m=c([]),f=c({}),h=c(!1),j=c(new Set),N=c(new Set),w=new Map,T=c(new Set),P=c(!0);function z(){const e=document.querySelector('meta[name="csrf-token"]');if(e&&e.getAttribute("content"))return e.getAttribute("content");const t=document.cookie.match(/(?:^|; )XSRF-TOKEN=([^;]+)/);return t?decodeURIComponent(t[1]):""}function G(e,t,s=0){const r=l(e,t);console.log("Scheduling save for",r),w.has(r)&&clearTimeout(w.get(r));const o=setTimeout(()=>{console.log("Auto-saving",r),saveSingle(e,t),w.delete(r)},s);w.set(r,o)}async function B(e){S.value=e,M.value=!0;try{const t=`/results/exams/${b.exam.id}/marks?class_id=${encodeURIComponent(e)}`,s=await fetch(t,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":z()}}),r=s.ok?await s.json():{students:[]};y.value=r.students||[],m.value=r.subjects||[],f.value=Object.assign({},r.marks||{})}finally{M.value=!1}}function V(e,t){const s=f.value[l(e,t)];return s==null||s===""?!1:typeof s!="number"?!0:s<0||s>100}const $=p(()=>{for(const e of y.value)for(const t of m.value)if(V(e.id,t.id))return!0;return!1}),L=p(()=>(m.value||[]).length||0);function D(e,t){const s=f.value[l(e,t)];return typeof s=="number"?s:null}const A=p(()=>{const e={};for(const t of y.value){let s=0;for(const r of m.value){const o=D(t.id,r.id);typeof o=="number"&&(s+=o)}e[t.id]=s}return e}),K=p(()=>{const e={},t=L.value||1;for(const s of y.value)e[s.id]=A.value[s.id]/t;return e}),H=p(()=>{const e=y.value.map(o=>({id:o.id,total:A.value[o.id]||0}));e.sort((o,v)=>v.total-o.total);const t={};let s=0,r=null;for(const o of e)(r===null||o.total<r)&&(s+=1),t[o.id]=s,r=o.total;return t});function U(e){return e>=75?"I":e>=60?"II":e>=45?"III":e>=30?"IV":"0"}function W(e){return e>=75?"A":e>=65?"B":e>=45?"C":e>=30?"D":"F"}Q(()=>{const e=(b.exam.classes||[])[0];e&&e.id&&B(e.id)});function l(e,t){return`${e}_${t}`}function q(e,t){P.value&&saveSingle(e,t)}function I(e,t,s){const r=s.target.value;if(r===""||r===null){f.value[l(e,t)]=null,T.value.add(l(e,t));return}let o=Number(r);if(Number.isNaN(o)){f.value[l(e,t)]=null,T.value.add(l(e,t));return}o<0&&(o=0,window.__toast&&window.__toast("warning","Marks cannot be below 0")),o>100&&(o=100,window.__toast&&window.__toast("warning","Marks cannot exceed 100")),f.value[l(e,t)]=o,T.value.add(l(e,t)),G(e,t)}const E=p(()=>{const e=(b.exam.classes||[]).find(t=>t.id===S.value);return e?e.name:null});async function J(){if(E.value){if($.value){window.__toast&&window.__toast("error","Fix invalid marks first");return}h.value=!0;try{const e=[];for(const s of y.value)for(const r of m.value){const o=l(s.id,r.id);if(o in f.value){const v=f.value[o];e.push({student_id:s.id,subject_id:r.id,marks:v===""?null:v})}}(await fetch(`/results/exams/${b.exam.id}/marks`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":z()},body:JSON.stringify({class_name:E.value,entries:e})})).ok?window.__toast?window.__toast("success","Marks saved"):alert("Marks saved"):window.__toast?window.__toast("error","Failed to save"):alert("Failed to save")}catch{window.__toast?window.__toast("error","Failed to save"):alert("Failed to save")}finally{h.value=!1}}}return(e,t)=>(i(),a(x,null,[O(Y(Z),{title:`Marks - ${g.exam.name}`},null,8,["title"]),O(te,null,{header:X(()=>[n("div",se,[n("h2",oe," Marks: "+d(g.exam.name)+" ("+d(g.exam.year)+"/T"+d(g.exam.term)+") ",1)])]),default:X(()=>[n("div",ne,[n("div",re,[t[1]||(t[1]=n("div",{class:"mb-3 text-sm font-medium text-gray-700"},"Classes",-1)),n("div",ae,[(i(!0),a(x,null,_(g.exam.classes||[],s=>(i(),a("button",{key:s.id,type:"button",onClick:r=>B(s.id),class:R(["rounded-md px-3 py-1.5 text-sm ring-1 ring-inset",S.value===s.id?"bg-green-600 text-white ring-green-600":"bg-white text-gray-700 ring-gray-300 hover:bg-gray-50"])},d(s.name),11,ie))),128)),!g.exam.classes||g.exam.classes.length===0?(i(),a("div",le,"No classes assigned to this exam.")):k("",!0)])]),n("div",de,[n("div",ue,[t[4]||(t[4]=n("div",{class:"text-sm font-medium text-gray-700"},"Students",-1)),n("div",ce,[n("div",ye,d(y.value.length)+" total",1),$.value?(i(),a("span",fe,"Fix invalid marks first")):k("",!0),n("button",{type:"button",onClick:J,disabled:h.value||$.value,class:"inline-flex items-center rounded-md bg-green-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-green-700 disabled:opacity-60"},[h.value?(i(),a("svg",me,[...t[2]||(t[2]=[n("circle",{cx:"12",cy:"12",r:"9","stroke-width":"2",opacity:"0.25"},null,-1),n("path",{d:"M21 12a9 9 0 0 1-9 9","stroke-width":"2"},null,-1)])])):k("",!0),t[3]||(t[3]=ee(" Save All ",-1))],8,ge)])]),M.value?(i(),a("div",ve,"Loading...")):(i(),a("div",pe,[y.value.length===0?(i(),a("div",xe,"Select a class to load students.")):(i(),a("div",be,[n("table",{class:"min-w-full border border-gray-200 text-sm",onKeydown:t[0]||(t[0]=C(F((...s)=>e.onGlobalEnter&&e.onGlobalEnter(...s),["stop","prevent"]),["enter"])),tabindex:"0"},[n("thead",he,[n("tr",null,[t[5]||(t[5]=n("th",{class:"sticky top-0 left-0 z-20 bg-gray-50 px-3 py-2 text-left font-semibold text-gray-700 border-r border-gray-200"},"Reg No",-1)),t[6]||(t[6]=n("th",{class:"sticky top-0 left-28 z-20 bg-gray-50 px-3 py-2 text-left font-semibold text-gray-700 border-r border-gray-200"},"Full Name",-1)),(i(!0),a(x,null,_(m.value,s=>(i(),a("th",{key:s.id,title:s.name||"",class:"sticky top-0 z-10 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 whitespace-nowrap border-r border-gray-200"},d((s.name||"").toString().slice(0,12)),9,we))),128)),t[7]||(t[7]=n("th",{class:"sticky top-0 z-10 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 whitespace-nowrap border-l border-gray-200"},"Total",-1)),t[8]||(t[8]=n("th",{class:"sticky top-0 z-10 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 whitespace-nowrap"},"Grade",-1)),t[9]||(t[9]=n("th",{class:"sticky top-0 z-10 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 whitespace-nowrap"},"Average",-1)),t[10]||(t[10]=n("th",{class:"sticky top-0 z-10 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 whitespace-nowrap"},"Position",-1)),t[11]||(t[11]=n("th",{class:"sticky top-0 z-10 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 whitespace-nowrap"},"Division",-1))])]),n("tbody",null,[(i(!0),a(x,null,_(y.value,(s,r)=>(i(),a("tr",{key:s.id,class:"odd:bg-gray-50 hover:bg-gray-50"},[n("td",ke,d(s.reg_no),1),n("td",_e,d(s.name),1),(i(!0),a(x,null,_(m.value,(o,v)=>(i(),a("td",{key:o.id,class:"px-2 py-1 text-center border-t border-r border-gray-200"},[n("div",Ce,[n("input",{type:"number",inputmode:"numeric",min:"0",max:"100",step:"1",value:f.value[l(s.id,o.id)]??"",placeholder:"",onInput:u=>I(s.id,o.id,u),onChange:u=>q(s.id,o.id),onBlur:u=>q(s.id,o.id),onKeydown:[C(F(u=>e.onTabVertical(r,o.id,"down"),["prevent"]),["enter"]),C(F(u=>e.onTabVertical(r,o.id,"down"),["prevent"]),["tab"]),C(F(u=>e.onTabVertical(r,o.id,"up"),["shift","prevent"]),["tab"])],onPaste:u=>e.onPaste(r,v,u),onFocus:u=>e.onCellFocus(r,o.id,u),"data-student":s.id,"data-subject":o.id,class:R(["marks-cell w-14 rounded-md border bg-white px-2 py-1 text-center text-sm placeholder-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-300 transition-shadow",V(s.id,o.id)?"border-rose-400 text-rose-700":"border-gray-300 text-gray-900",j.value.has(l(s.id,o.id))?"ring-2 ring-emerald-400":"",N.value.has(l(s.id,o.id))?"opacity-70 cursor-wait":""]),disabled:N.value.has(l(s.id,o.id))},null,42,Fe),j.value.has(l(s.id,o.id))?(i(),a("span",Se,[...t[12]||(t[12]=[n("svg",{viewBox:"0 0 20 20",fill:"none",class:"h-2.5 w-2.5"},[n("path",{d:"M5 10l3 3 7-7",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):N.value.has(l(s.id,o.id))?(i(),a("span",Me,[...t[13]||(t[13]=[n("svg",{class:"h-2.5 w-2.5 animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[n("circle",{cx:"12",cy:"12",r:"9","stroke-opacity":"0.25"}),n("path",{d:"M21 12a9 9 0 0 1-9 9","stroke-linecap":"round"})],-1)])])):k("",!0)])]))),128)),n("td",Ne,d(A.value[s.id]??0),1),n("td",Te,d(W(K.value[s.id]??0)),1),n("td",$e,d((K.value[s.id]??0).toFixed(1)),1),n("td",Ae,d(H.value[s.id]??"-"),1),n("td",Ke,d(U(K.value[s.id]??0)),1)]))),128))])],32)]))]))])])]),_:1})],64))}};export{Be as default};

import{r as _,g as p,h as z,c as l,a as I,u as q,m as D,w as B,b as t,i as M,z as E,o,F as h,k as w,t as d,B as O,y as U,l as X,e as H}from"./app-BoWaoUwb.js";import{_ as W}from"./AuthenticatedLayout-CQFJTYU6.js";import"./DropdownLink-v00n1gGZ.js";const Y={class:"flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between"},Z={class:"text-xl font-semibold leading-tight text-gray-800"},G={class:"mt-1 text-sm text-gray-600"},J={class:"flex items-center gap-2"},K={class:"space-y-4"},Q={class:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"},tt={class:"grid w-full grid-cols-1 gap-2 sm:grid-cols-3"},et=["value"],st=["value"],at={class:"grid grid-cols-1 gap-4 md:grid-cols-3"},lt={class:"rounded-lg border bg-white p-4 shadow-sm"},ot={class:"mt-3 flex items-center gap-4"},dt={viewBox:"0 0 120 120",width:"120",height:"120"},rt=["d"],nt=["d"],it={class:"text-2xl font-semibold text-gray-900"},ut={class:"text-xs text-gray-500"},ct={class:"md:col-span-2 rounded-lg border bg-white p-4 shadow-sm"},mt={class:"mt-3 space-y-2"},vt={class:"w-40 truncate text-xs text-gray-700"},xt={class:"h-3 w-full rounded bg-gray-100"},ht={class:"w-10 text-right text-xs text-gray-700"},gt={key:0,class:"text-xs text-gray-500"},yt={class:"overflow-hidden rounded-lg border bg-white shadow-sm"},ft={class:"overflow-x-auto"},pt={class:"min-w-full divide-y divide-gray-200 text-sm"},bt={class:"divide-y divide-gray-100"},_t={key:0},wt={class:"px-4 py-2 text-gray-900"},kt={class:"px-4 py-2 text-gray-800"},jt={class:"px-4 py-2 text-gray-700"},$t={class:"px-4 py-2 text-gray-900"},Mt={key:0},Nt={key:0,class:"rounded-md border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"},It={__name:"Exam",props:{teacher:{type:Object,required:!0},exam:{type:Object,required:!0}},setup(c){const N=c,b=_(""),g=_(""),V=_(!1),k=_(""),u=_({subjects:[],students:[],marks:{}}),C=p(()=>new Set((N.teacher.subjects||[]).map(a=>a.id))),R=p(()=>N.teacher.classes||[]),T=p(()=>(u.value.subjects||[]).filter(a=>C.value.has(a.id)));async function F(){if(k.value="",u.value={subjects:[],students:[],marks:{}},!!b.value){V.value=!0;try{const a=route("results.exams.marks",{examId:N.exam.id})+`?class_id=${b.value}`,s=await fetch(a,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error("Failed to load");const e=await s.json(),r=Array.isArray(e?.subjects)?e.subjects:[],m=Array.isArray(e?.students)?e.students:[],v=e?.marks||{},n=r.filter(i=>C.value.has(i.id));u.value={subjects:n,students:m,marks:v}}catch{k.value="Could not load results. Please try again."}finally{V.value=!1}}}const j=p(()=>{const a=u.value.subjects||[],s=u.value.students||[],e=u.value.marks||{},r=g.value?Number(g.value):null;let m=0,v=0;const n=[];for(const i of a){if(r&&i.id!==r)continue;let x=0,y=0,$=0;for(const S of s){const A=`${S.id}_${i.id}`,f=Number(e[A]??NaN);Number.isFinite(f)&&(x+=f,y+=1,f>=40&&($+=1),m+=1,f>=40&&(v+=1))}n.push({id:i.id,name:i.name,avg:y?Math.round(x/y*10)/10:0,cnt:y,pass:$})}return n.sort((i,x)=>x.avg-i.avg),{total:m,pass:v,perSubject:n}}),P=p(()=>{const a=j.value.total||1,s=j.value.pass,e=s/a*2*Math.PI;function r(m,v,n,i,x){const y=m+n*Math.cos(i),$=v+n*Math.sin(i),S=m+n*Math.cos(x),A=v+n*Math.sin(x),f=x-i>Math.PI?1:0;return`M ${m} ${v} L ${y} ${$} A ${n} ${n} 0 ${f} 1 ${S} ${A} Z`}return{passPath:r(60,60,50,0,e),failPath:r(60,60,50,e,2*Math.PI),passPct:Math.round(s/a*100)}}),L=p(()=>{const a=j.value.perSubject,s=Math.max(100,...a.map(e=>e.avg));return a.map((e,r)=>({name:e.name,width:Math.max(0,e.avg/s*100),value:e.avg,idx:r}))});return z(b,F),(a,s)=>(o(),l(h,null,[I(q(D),{title:`Exam • ${c.exam.name} • ${c.teacher.name}`},null,8,["title"]),I(W,null,{header:B(()=>[t("div",Y,[t("div",null,[t("h2",Z,d(c.teacher.name)+" — "+d(c.exam.name),1),t("div",G,"Type: "+d(c.exam.type)+" · Year "+d(c.exam.year)+" · Term "+d(c.exam.term),1)]),t("div",J,[I(q(X),{href:a.route("teachers.show",{id:c.teacher.id}),class:"text-sm text-emerald-700 hover:text-emerald-900"},{default:B(()=>[...s[2]||(s[2]=[H("← Back to teacher",-1)])]),_:1},8,["href"])])])]),default:B(()=>[t("div",K,[t("div",Q,[t("div",tt,[E(t("select",{"onUpdate:modelValue":s[0]||(s[0]=e=>b.value=e),class:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-emerald-500 focus:ring-emerald-500"},[s[3]||(s[3]=t("option",{value:""},"Select class...",-1)),(o(!0),l(h,null,w(R.value,e=>(o(),l("option",{key:e.id,value:e.id},d(e.name),9,et))),128))],512),[[O,b.value]]),E(t("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>g.value=e),class:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-emerald-500 focus:ring-emerald-500"},[s[4]||(s[4]=t("option",{value:""},"All subjects",-1)),(o(!0),l(h,null,w(T.value,e=>(o(),l("option",{key:e.id,value:e.id},d(e.name),9,st))),128))],512),[[O,g.value]]),t("button",{onClick:F,class:"rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50"},"Load")])]),t("div",at,[t("div",lt,[s[5]||(s[5]=t("div",{class:"text-sm font-medium text-gray-600"},"Pass rate",-1)),t("div",ot,[(o(),l("svg",dt,[t("path",{d:P.value.failPath,fill:"#fee2e2"},null,8,rt),t("path",{d:P.value.passPath,fill:"#34d399"},null,8,nt)])),t("div",null,[t("div",it,d(P.value.passPct)+"%",1),t("div",ut,"of "+d(j.value.total)+" marks",1)])])]),t("div",ct,[s[6]||(s[6]=t("div",{class:"text-sm font-medium text-gray-600"},"Average by subject",-1)),t("div",mt,[(o(!0),l(h,null,w(L.value,e=>(o(),l("div",{key:e.idx,class:"flex items-center gap-3"},[t("div",vt,d(e.name),1),t("div",xt,[t("div",{class:"h-3 rounded bg-emerald-500",style:U({width:e.width+"%"})},null,4)]),t("div",ht,d(e.value),1)]))),128)),L.value.length===0?(o(),l("div",gt,"No data")):M("",!0)])])]),t("div",yt,[t("div",ft,[t("table",pt,[s[8]||(s[8]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"},"Reg No"),t("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"},"Student"),t("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"},"Subject"),t("th",{class:"px-4 py-3 text-left font-semibold text-gray-700"},"Marks")])],-1)),t("tbody",bt,[(o(!0),l(h,null,w(u.value.students,e=>(o(),l(h,{key:e.id},[(o(!0),l(h,null,w(u.value.subjects,r=>(o(),l(h,{key:r.id},[!g.value||Number(g.value)===r.id?(o(),l("tr",_t,[t("td",wt,d(e.reg_no),1),t("td",kt,d(e.name),1),t("td",jt,d(r.name),1),t("td",$t,d(Number(u.value.marks[`${e.id}_${r.id}`]??NaN)||""),1)])):M("",!0)],64))),128))],64))),128)),(u.value.students||[]).length===0||(u.value.subjects||[]).length===0?(o(),l("tr",Mt,[...s[7]||(s[7]=[t("td",{colspan:"4",class:"px-4 py-8 text-center text-sm text-gray-500"},"Select class and click Load to view results.",-1)])])):M("",!0)])])])]),k.value?(o(),l("div",Nt,d(k.value),1)):M("",!0)])]),_:1})],64))}};export{It as default};

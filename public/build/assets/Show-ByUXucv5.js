import{C as J,m as D,r as x,B as Y,k as l,a as $,d as G,h as Q,w as N,b as s,n as V,t as r,o as d,F as y,x as f,p as h,l as q,f as k,D as I,y as R,v as Z,i as K,g as ee}from"./app-YxQuFUj0.js";import{_ as te}from"./AuthenticatedLayout-DZRh6SQw.js";const se={class:"flex items-center justify-between"},ae={class:"text-xl font-semibold leading-tight text-gray-800"},oe={class:"flex gap-2"},ne=["disabled"],re=["disabled"],le={class:"space-y-4"},de={class:"rounded-xl border border-gray-100 bg-white p-4 shadow-sm"},ie={class:"flex flex-wrap gap-2"},ue=["onClick"],me={class:"rounded-xl border border-gray-100 bg-white p-4 shadow-sm"},ce={class:"grid gap-4 sm:grid-cols-2"},xe={key:0,class:"mt-1 text-xs text-red-600"},ye=["value"],ve={class:"rounded-xl border border-gray-100 bg-white p-4 shadow-sm"},ge={class:"mb-2 flex items-center justify-between"},pe={class:"text-xs text-gray-500"},fe={class:"flex max-h-60 flex-wrap gap-2 overflow-auto rounded-md border border-gray-200 p-2"},be=["value"],_e={class:"rounded-xl border border-gray-100 bg-white p-4 shadow-sm"},we={class:"mb-2 text-sm font-semibold text-gray-700"},he={key:0,class:"text-sm text-gray-500"},ke={key:1,class:"overflow-x-auto"},Se={class:"min-w-full divide-y divide-gray-200 text-sm"},Ce={class:"bg-gray-50"},De={class:"divide-y divide-gray-100"},Ee={class:"px-3 py-2 text-gray-900 whitespace-nowrap"},Fe={class:"px-3 py-2 text-gray-700 whitespace-nowrap"},Me=["id","value","onInput","onKeydown"],je={class:"px-3 py-2 text-center text-gray-700"},Ae={class:"px-3 py-2 text-center text-gray-700"},Te={class:"px-3 py-2 text-center text-gray-700"},$e={class:"px-3 py-2 text-center text-gray-700"},Ne={key:0},Ve=["colspan"],Re={__name:"Show",props:{exam:{type:Object,required:!0},classes:{type:Array,required:!0},types:{type:Array,required:!0},students:{type:Array,default:()=>[]}},setup(v){const i=v,B=J(),A=D(()=>B.props.errors||{}),m=x({name:i.exam.name,type:i.exam.type,year:i.exam.year,term:i.exam.term,class_ids:(i.exam.classes||[]).map(a=>a.id)}),S=x(!1);async function O(){S.value=!0;try{await K.patch(route("results.exams.update",{id:i.exam.id}),m.value,{preserveScroll:!0,onSuccess:()=>{window.__toast&&window.__toast("success","Exam updated")},onError:a=>{const e=Object.values(a||{})[0]||"Failed to update";window.__toast&&window.__toast("error",String(e))}})}finally{S.value=!1}ee(()=>{!u.value&&Array.isArray(i.exam.classes)&&i.exam.classes.length&&(u.value=i.exam.classes[0].name)})}const C=x(!1);async function U(){if(confirm("Delete this exam?")){C.value=!0;try{await K.delete(route("results.exams.destroy",{id:i.exam.id}),{preserveScroll:!0,onSuccess:()=>{window.__toast&&window.__toast("success","Exam deleted")},onError:()=>{window.__toast&&window.__toast("error","Failed to delete")}})}finally{C.value=!1}}}const u=x(""),X=D(()=>{const a=(i.exam.classes||[]).map(t=>t.name),e={};for(const t of i.students||[])e[t.class_name]=(e[t.class_name]||0)+1;return a.map(t=>({name:t,count:e[t]||0}))}),E=D(()=>{const a=i.students||[];return u.value?a.filter(e=>e.class_name===u.value):a}),g=x([]),b=x({}),F=x({});let M;async function L(){if(!u.value){g.value=[],b.value={};return}try{const a=route("results.exams.marks",{examId:i.exam.id,class_name:u.value}),e=await fetch(a,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!e.ok){window.__toast&&window.__toast("error","Failed to load marks");return}const t=await e.json();g.value=t.subjects||[],b.value=t.marks||{}}catch{window.__toast&&window.__toast("error","Failed to load marks")}}Y(u,()=>{L()});function _(a,e){return`${a}_${e}`}function P(a,e){const t=b.value[_(a,e)];return t==null?"":String(t)}function H(a,e,t){const o=_(a,e),n=t===""?null:Math.max(0,Math.min(100,Number(t)));b.value[o]=n,F.value[o]=!0,w([{student_id:a,subject_id:e,marks:n}])}function w(a){M&&clearTimeout(M),w._buf||(w._buf=[]),w._buf.push(...a),M=setTimeout(async()=>{const e=(w._buf||[]).splice(0);if(e.length!==0)try{await fetch(route("results.exams.marks.save",{examId:i.exam.id}),{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector("meta[name=csrf-token]")?.getAttribute("content")||""},body:JSON.stringify({class_name:u.value,entries:e})});for(const t of e)F.value[_(t.student_id,t.subject_id)]=!1}catch{window.__toast&&window.__toast("error","Failed to save");for(const o of e)F.value[_(o.student_id,o.subject_id)]=!1}},400)}function j(a){let e=0,t=0;for(const o of g.value){const n=b.value[_(a.id,o.id)];typeof n=="number"&&(e+=n,t++)}return{sum:e,count:t,avg:t?e/t:0}}function W(a){return a>=75?"Div I":a>=65?"Div II":a>=55?"Div III":a>=40?"Div IV":"Fail"}const T=D(()=>{const a=(E.value||[]).map(o=>{const n=j(o);return{id:o.id,sum:n.sum,avg:n.avg}});a.sort((o,n)=>n.sum-o.sum);let e=null,t=0;return a.reduce((o,n,c)=>{const p=n.sum===e?t:c+1;return e=n.sum,t=p,o[n.id]={rank:p,sum:n.sum,avg:n.avg,div:W(n.avg)},o},{})});function z(a,e,t){const o=a.key==="Enter"?a.shiftKey?-1:1:0;if(o!==0){a.preventDefault();const n=e+o;if(n>=0){const c=document.getElementById(`cell-${n}-${t}`);c&&c.focus()}}}return(a,e)=>(d(),l(y,null,[$(G(Q),{title:`Exam: ${v.exam.name}`},null,8,["title"]),$(te,null,{header:N(()=>[s("div",se,[s("h2",ae,"Exam: "+r(v.exam.name),1),s("div",oe,[s("button",{disabled:S.value,onClick:O,class:"rounded-md bg-green-600 px-3 py-2 text-sm font-medium text-white hover:bg-green-700 disabled:opacity-60"},r(S.value?"Saving...":"Save"),9,ne),s("button",{disabled:C.value,onClick:U,class:"rounded-md bg-rose-600 px-3 py-2 text-sm font-medium text-white hover:bg-rose-700 disabled:opacity-60"},r(C.value?"Deleting...":"Delete"),9,re)])])]),default:N(()=>[s("div",le,[s("div",de,[e[6]||(e[6]=s("div",{class:"mb-2 text-sm font-semibold text-gray-700"},"Assigned classes",-1)),s("div",ie,[s("button",{type:"button",onClick:e[0]||(e[0]=t=>u.value=""),class:V(["rounded-full px-3 py-1 text-xs",u.value===""?"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])}," All ("+r((v.students||[]).length)+") ",3),(d(!0),l(y,null,f(X.value,t=>(d(),l("button",{key:t.name,type:"button",onClick:o=>u.value=t.name,class:V(["rounded-full px-3 py-1 text-xs",u.value===t.name?"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},r(t.name)+" ("+r(t.count)+") ",11,ue))),128))])]),s("div",me,[s("div",ce,[s("div",null,[e[7]||(e[7]=s("label",{class:"mb-1 block text-xs font-medium text-gray-600"},[k("Exam name "),s("span",{class:"text-red-600"},"*")],-1)),h(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>m.value.name=t),type:"text",class:"w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-green-600 focus:ring-green-600"},null,512),[[I,m.value.name]]),A.value.name?(d(),l("p",xe,r(A.value.name),1)):q("",!0)]),s("div",null,[e[8]||(e[8]=s("label",{class:"mb-1 block text-xs font-medium text-gray-600"},[k("Type "),s("span",{class:"text-red-600"},"*")],-1)),h(s("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>m.value.type=t),class:"w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-green-600 focus:ring-green-600"},[(d(!0),l(y,null,f(v.types,t=>(d(),l("option",{key:t,value:t},r(t),9,ye))),128))],512),[[R,m.value.type]])]),s("div",null,[e[9]||(e[9]=s("label",{class:"mb-1 block text-xs font-medium text-gray-600"},[k("Year "),s("span",{class:"text-red-600"},"*")],-1)),h(s("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>m.value.year=t),type:"number",min:"2000",max:"2100",class:"w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-green-600 focus:ring-green-600"},null,512),[[I,m.value.year]])]),s("div",null,[e[11]||(e[11]=s("label",{class:"mb-1 block text-xs font-medium text-gray-600"},[k("Term "),s("span",{class:"text-red-600"},"*")],-1)),h(s("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>m.value.term=t),class:"w-full rounded-md border-gray-300 text-sm shadow-sm focus:border-green-600 focus:ring-green-600"},[...e[10]||(e[10]=[s("option",{value:1},"1",-1),s("option",{value:2},"2",-1),s("option",{value:3},"3",-1)])],512),[[R,m.value.term]])])])]),s("div",ve,[s("div",ge,[e[12]||(e[12]=s("div",{class:"text-sm font-semibold text-gray-700"},"Assign classes",-1)),s("div",pe,"Selected: "+r(m.value.class_ids.length),1)]),s("div",fe,[(d(!0),l(y,null,f(v.classes,t=>(d(),l("label",{key:t.id,class:"flex items-center gap-2 rounded-md bg-gray-50 px-2 py-1 text-sm text-gray-700 ring-1 ring-inset ring-gray-200"},[h(s("input",{type:"checkbox",value:t.id,"onUpdate:modelValue":e[5]||(e[5]=o=>m.value.class_ids=o)},null,8,be),[[Z,m.value.class_ids]]),k(" "+r(t.name),1)]))),128))])]),s("div",_e,[s("div",we,"Marks "+r(u.value?`- ${u.value}`:""),1),u.value?(d(),l("div",ke,[s("table",Se,[s("thead",Ce,[s("tr",null,[e[13]||(e[13]=s("th",{class:"px-3 py-2 text-left font-semibold text-gray-700"},"Reg No",-1)),e[14]||(e[14]=s("th",{class:"px-3 py-2 text-left font-semibold text-gray-700"},"Name",-1)),(d(!0),l(y,null,f(g.value,(t,o)=>(d(),l("th",{key:t.id,class:"px-3 py-2 text-center font-semibold text-gray-700"},r(t.code||t.name),1))),128)),e[15]||(e[15]=s("th",{class:"px-3 py-2 text-center font-semibold text-gray-700"},"Total",-1)),e[16]||(e[16]=s("th",{class:"px-3 py-2 text-center font-semibold text-gray-700"},"Average",-1)),e[17]||(e[17]=s("th",{class:"px-3 py-2 text-center font-semibold text-gray-700"},"Position",-1)),e[18]||(e[18]=s("th",{class:"px-3 py-2 text-center font-semibold text-gray-700"},"Division",-1))])]),s("tbody",De,[(d(!0),l(y,null,f(E.value,(t,o)=>(d(),l("tr",{key:t.id,class:"hover:bg-gray-50"},[s("td",Ee,r(t.reg_no),1),s("td",Fe,r(t.name),1),(d(!0),l(y,null,f(g.value,(n,c)=>(d(),l("td",{key:n.id,class:"px-2 py-1 text-center"},[s("input",{id:`cell-${o}-${c}`,type:"number",min:"0",max:"100",step:"1",value:P(t.id,n.id),onInput:p=>H(t.id,n.id,p.target.value),onKeydown:p=>z(p,o,c),class:"w-16 rounded-md border-gray-300 text-center text-sm shadow-sm focus:border-green-600 focus:ring-green-600"},null,40,Me)]))),128)),s("td",je,r(j(t).sum.toFixed(0)),1),s("td",Ae,r(j(t).avg.toFixed(1)),1),s("td",Te,r(T.value[t.id]?.rank||"-"),1),s("td",$e,r(T.value[t.id]?.div||"-"),1)]))),128)),E.value.length===0?(d(),l("tr",Ne,[s("td",{colspan:4+(g.value.length||0),class:"px-4 py-8 text-center text-sm text-gray-500"},"No students found.",8,Ve)])):q("",!0)])])])):(d(),l("div",he,"Select a class chip above to enter marks."))])])]),_:1})],64))}};export{Re as default};
